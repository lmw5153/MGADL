# -*- coding: utf-8 -*-
"""MGADL.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1FJZJCqagIpPV6ZDQzh7YSEk3zZRPe09Q
"""

import streamlit as st
import pandas as pd
from datetime import datetime
import hashlib
import gspread
from google.oauth2.service_account import Credentials

# -----------------------------
# ê¸°ë³¸ ì„¤ì •
# -----------------------------
st.set_page_config(page_title="MG-ADL ì„¤ë¬¸", page_icon="ğŸ§ ", layout="centered")

APP_PASSWORD = "0712"

SHEET_ID = st.secrets.get("SHEET_ID", "")
WORKSHEET_NAME = st.secrets.get("WORKSHEET_NAME", "responses")
SALT = st.secrets.get("SALT", "")
SA_INFO = st.secrets.get("GOOGLE_SERVICE_ACCOUNT", None)

# -----------------------------
# MG-ADL ë¬¸í•­ ì •ì˜ (0~3)
# -----------------------------
ITEMS = [
    {"id":"mgadl_01_talking","question":"ë§í•˜ê¸°","choices":{
        0:"ì •ìƒ",1:"ë•Œë•Œë¡œ ë¶ˆë¶„ëª…í•˜ê±°ë‚˜ ì½§ì†Œë¦¬ ë‚˜ëŠ” ë°œìŒ",2:"ë¶ˆë¶„ëª…í•˜ê±°ë‚˜ ì½§ì†Œë¦¬ê°€ ë‚˜ëŠ” ë°œìŒì´ ì§€ì†ë˜ë‚˜ ì´í•´í•  ìˆ˜ ìˆìŒ",3:"ë§ì„ ì´í•´í•˜ê¸° ì–´ë ¤ì›€"}},
    {"id":"mgadl_02_chewing","question":"ì”¹ê¸°","choices":{
        0:"ì •ìƒ",1:"ê³ í˜• ìŒì‹ì„ ì”¹ê¸°ê°€ ì–´ë ¤ì›€",2:"ë¶€ë“œëŸ¬ìš´ ìŒì‹ì„ ì”¹ê¸°ê°€ ì–´ë ¤ì›€",3:"ìœ„ì¥ ì˜ì–‘ê´€"}},
    {"id":"mgadl_03_swallowing","question":"ì‚¼í‚¤ê¸°","choices":{
        0:"ì •ìƒ",1:"ë“œë¬¼ê²Œ ì‚¬ë˜ ë“¤ë¦¬ëŠ” ê²½ìš°ê°€ ìˆìŒ",2:"ìì£¼ ì‚¬ë˜ ë“¤ë ¤ ì‹ì‚¬ì— ë³€í™”ë¥¼ ì¤„ í•„ìš”ê°€ ìˆìŒ",3:"ìœ„ì¥ ì˜ì–‘ê´€"}},
    {"id":"mgadl_04_breathing","question":"ìˆ¨ì‰¬ê¸°","choices":{
        0:"ì •ìƒ",1:"í˜ë“  í™œë™ ì‹œ ìˆ¨ê°€ì¨",2:"íœ´ì‹ ì‹œ ìˆ¨ê°€ì¨",3:"ì¸ê³µí˜¸í¡ê¸°ì˜ì¡´"}},
    {"id":"mgadl_05_brush_teeth_hair","question":"ì–‘ì¹˜ë‚˜ ë¨¸ë¦¬ë¥¼ ë¹—ì„ ë•Œ","choices":{
        0:"ì–´ë ¤ì›€ ì—†ìŒ",1:"í˜ì´ ë” ë“¤ì§€ë§Œ ì‰¬ëŠ” ê¸°ê°„ì´ í•„ìš”í•˜ì§€ ì•ŠìŒ",2:"ì‰¬ëŠ” ê¸°ê°„ì´ í•„ìš”í•¨",3:"ì´ ê¸°ëŠ¥ ì¤‘ í•œ ê°€ì§€ë¥¼ í•  ìˆ˜ ì—†ìŒ"}},
    {"id":"mgadl_06_arise_from_chair","question":"ì˜ìì—ì„œ ì¼ì–´ì„¤ ë•Œ","choices":{
        0:"ì–´ë ¤ì›€ ì—†ìŒ",1:"ê²½ì¦ìœ¼ë¡œ, ê°€ë” íŒ”ì„ ì‚¬ìš©í•¨",2:"ì¤‘ë“±ë„ë¡œ, í•­ìƒ íŒ”ì„ ì‚¬ìš©í•¨",3:"ì¤‘ì¦ìœ¼ë¡œ, ë„ì›€ì´ í•„ìš”í•¨"}},
    {"id":"mgadl_07_diplopia","question":"ê²¹ì³ë³´ì„(ë³µì‹œ)","choices":{
        0:"ì—†ìŒ",1:"ë°œìƒí•˜ë‚˜ ë§¤ì¼ ë°œìƒí•˜ì§€ëŠ” ì•ŠìŒ",2:"ë§¤ì¼ ë°œìƒí•˜ë‚˜ ì§€ì†ì ì´ì§€ëŠ” ì•ŠìŒ",3:"ì§€ì†ì ì„"}},
    {"id":"mgadl_08_ptosis","question":"ëˆˆêº¼í’€ì²˜ì§(ì•ˆê²€í•˜ìˆ˜)","choices":{
        0:"ì—†ìŒ",1:"ë°œìƒí•˜ë‚˜ ë§¤ì¼ ë°œìƒí•˜ì§€ëŠ” ì•ŠìŒ",2:"ë§¤ì¼ ë°œìƒí•˜ë‚˜ ì§€ì†ì ì´ì§€ëŠ” ì•ŠìŒ",3:"ì§€ì†ì ì„"}},
]

# -----------------------------
# ìœ í‹¸
# -----------------------------
def patient_hash(name: str, dob: str) -> str:
    raw = f"{name}|{dob}|{SALT}".encode("utf-8")
    return hashlib.sha256(raw).hexdigest()[:16]

def compute_total(responses: dict) -> int:
    return int(sum(int(v) for v in responses.values()))

def get_sheet():
    if not SHEET_ID or not SA_INFO:
        raise RuntimeError("SHEET_ID ë˜ëŠ” GOOGLE_SERVICE_ACCOUNT secrets ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.")
    scopes = ["https://www.googleapis.com/auth/spreadsheets"]
    creds = Credentials.from_service_account_info(SA_INFO, scopes=scopes)
    gc = gspread.authorize(creds)
    sh = gc.open_by_key(SHEET_ID)
    ws = sh.worksheet(WORKSHEET_NAME)
    return ws

def ensure_header(ws):
    """
    ì‹œíŠ¸ê°€ ë¹„ì–´ìˆìœ¼ë©´ í—¤ë”ë¥¼ 1í–‰ì— ìƒì„±
    """
    header = (
        ["created_at", "name", "dob", "patient_hash", "total_score"]
        + [it["id"] for it in ITEMS]
    )
    values = ws.get_all_values()
    if len(values) == 0:
        ws.append_row(header, value_input_option="USER_ENTERED")

def append_to_sheet(record: dict):
    """
    record:
      created_at, name, dob, patient_hash, total_score, responses(dict)
    """
    ws = get_sheet()
    ensure_header(ws)

    row = [
        record["created_at"],
        record["name"],
        record["dob"],
        record["patient_hash"],
        record["total_score"],
    ]
    for it in ITEMS:
        row.append(int(record["responses"].get(it["id"], 0)))

    ws.append_row(row, value_input_option="USER_ENTERED")

def reset_all():
    for k in ["authed", "patient", "responses", "saved"]:
        st.session_state.pop(k, None)

# -----------------------------
# ì„¸ì…˜ ì´ˆê¸°í™”
# -----------------------------
if "authed" not in st.session_state:
    st.session_state["authed"] = False

if "patient" not in st.session_state:
    st.session_state["patient"] = {"name": "", "dob": ""}

if "responses" not in st.session_state:
    st.session_state["responses"] = {}

if "saved" not in st.session_state:
    st.session_state["saved"] = False

# -----------------------------
# UI
# -----------------------------
st.title("ğŸ§  MG-ADL ì„¤ë¬¸ (Google Sheet ëˆ„ì  ì €ì¥)")
st.caption("1) ì •ë³´/ë¹„ë°€ë²ˆí˜¸ â†’ 2) ì„¤ë¬¸ â†’ 3) ê²°ê³¼/ì €ì¥")

with st.sidebar:
    st.subheader("ë©”ë‰´")
    page = st.radio("ì´ë™", ["1) ì´ë¦„/ìƒë…„ì›”ì¼", "2) ì„¤ë¬¸", "3) ê²°ê³¼/ì €ì¥"], index=0)
    st.divider()
    st.write("ì ‘ì† ìƒíƒœ:", "âœ… ì¸ì¦ë¨" if st.session_state["authed"] else "â›” ë¯¸ì¸ì¦")
    c1, c2 = st.columns(2)
    with c1:
        if st.button("ë¡œê·¸ì•„ì›ƒ"):
            st.session_state["authed"] = False
            st.rerun()
    with c2:
        if st.button("ì´ˆê¸°í™”"):
            reset_all()
            st.rerun()

# ë¯¸ì¸ì¦ì´ë©´ í˜ì´ì§€2/3 ì ‘ê·¼ ì°¨ë‹¨(ì•ˆì „)
if not st.session_state["authed"] and page != "1) ì´ë¦„/ìƒë…„ì›”ì¼":
    st.warning("ë¨¼ì € 1) í˜ì´ì§€ì—ì„œ ë¹„ë°€ë²ˆí˜¸ ì¸ì¦ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.")
    st.stop()

# -----------------------------
# í˜ì´ì§€ 1: ë¹„ë°€ë²ˆí˜¸ + ì´ë¦„/ìƒë…„ì›”ì¼
# -----------------------------
if page == "1) ì´ë¦„/ìƒë…„ì›”ì¼":
    st.header("1) ëŒ€ìƒì ì •ë³´ ì…ë ¥ (ë¹„ë°€ë²ˆí˜¸ ì¸ì¦ í¬í•¨)")

    if not st.session_state["authed"]:
        with st.form("auth_form"):
            pw = st.text_input("ì ‘ì† ë¹„ë°€ë²ˆí˜¸", type="password", placeholder="0712")
            ok = st.form_submit_button("ì¸ì¦")
        if ok:
            if pw == APP_PASSWORD:
                st.session_state["authed"] = True
                st.success("ì¸ì¦ ì™„ë£Œ!")
                st.rerun()
            else:
                st.error("ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.")
        st.stop()

    # ì¸ì¦ í›„ ì…ë ¥ í¼
    with st.form("patient_form", clear_on_submit=False):
        name = st.text_input("ì´ë¦„", value=st.session_state["patient"]["name"], placeholder="ì˜ˆ: í™ê¸¸ë™")
        dob = st.date_input("ìƒë…„ì›”ì¼", value=None)
        submitted = st.form_submit_button("ì €ì¥í•˜ê³  ë‹¤ìŒìœ¼ë¡œ")

    if submitted:
        if not name.strip():
            st.error("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")
        elif dob is None:
            st.error("ìƒë…„ì›”ì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.")
        else:
            st.session_state["patient"]["name"] = name.strip()
            st.session_state["patient"]["dob"] = dob.isoformat()
            st.session_state["saved"] = False
            st.success("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ì‚¬ì´ë“œë°”ì—ì„œ '2) ì„¤ë¬¸'ìœ¼ë¡œ ì´ë™í•˜ì„¸ìš”.")

    if st.session_state["patient"]["name"] and st.session_state["patient"]["dob"]:
        st.info(f"í˜„ì¬ ì…ë ¥ë¨ â†’ ì´ë¦„: {st.session_state['patient']['name']}, ìƒë…„ì›”ì¼: {st.session_state['patient']['dob']}")

# -----------------------------
# í˜ì´ì§€ 2: ì„¤ë¬¸
# -----------------------------
elif page == "2) ì„¤ë¬¸":
    st.header("2) MG-ADL ì„¤ë¬¸")

    if not (st.session_state["patient"]["name"] and st.session_state["patient"]["dob"]):
        st.warning("ë¨¼ì € 1) í˜ì´ì§€ì—ì„œ ì´ë¦„/ìƒë…„ì›”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")
        st.stop()

    st.write(f"ëŒ€ìƒì: **{st.session_state['patient']['name']}** (DOB: {st.session_state['patient']['dob']})")

    with st.form("survey_form"):
        responses = {}
        for item in ITEMS:
            options = list(item["choices"].keys())
            labels = [f"{k}ì  - {item['choices'][k]}" for k in options]
            prev = st.session_state["responses"].get(item["id"], 0)
            idx = options.index(int(prev)) if int(prev) in options else 0

            choice_label = st.radio(
                label=f"**{item['question']}**",
                options=labels,
                index=idx,
                key=f"radio_{item['id']}",
            )
            score = int(choice_label.split("ì ")[0].strip())
            responses[item["id"]] = score

        submitted = st.form_submit_button("ì‘ë‹µ ì €ì¥")

    if submitted:
        st.session_state["responses"] = responses
        st.session_state["saved"] = False
        total = compute_total(responses)
        st.success(f"ì‘ë‹µì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. í˜„ì¬ ì´ì : **{total} / 24**")
        st.info("ì‚¬ì´ë“œë°”ì—ì„œ '3) ê²°ê³¼/ì €ì¥'ìœ¼ë¡œ ì´ë™í•˜ì„¸ìš”.")

# -----------------------------
# í˜ì´ì§€ 3: ê²°ê³¼/ì €ì¥ (Google Sheet append)
# -----------------------------
else:
    st.header("3) ê²°ê³¼/ì €ì¥ (Google Sheet ëˆ„ì )")

    if not st.session_state["responses"]:
        st.warning("ë¨¼ì € 2) ì„¤ë¬¸ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.")
        st.stop()

    name = st.session_state["patient"]["name"]
    dob = st.session_state["patient"]["dob"]
    ph = patient_hash(name, dob)
    total = compute_total(st.session_state["responses"])

    st.subheader("ê²°ê³¼")
    st.metric("MG-ADL ì´ì ", f"{total} / 24")

    rows = []
    for item in ITEMS:
        sc = int(st.session_state["responses"].get(item["id"], 0))
        rows.append({"ë¬¸í•­": item["question"], "ì ìˆ˜": sc, "ì„ íƒ": item["choices"][sc]})
    st.dataframe(pd.DataFrame(rows), use_container_width=True)

    st.divider()
    st.subheader("ì €ì¥")
    st.caption("â€˜ê²°ê³¼ ì €ì¥â€™ì„ ëˆ„ë¥¼ ë•Œë§ˆë‹¤ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì— **ìƒˆ í–‰ìœ¼ë¡œ ëˆ„ì (append)** ë©ë‹ˆë‹¤.")

    if st.button("ğŸ’¾ ê²°ê³¼ ì €ì¥(ìŠ¤í”„ë ˆë“œì‹œíŠ¸)", type="primary", disabled=st.session_state["saved"]):
        record = {
            "created_at": datetime.now().isoformat(timespec="seconds"),
            "name": name,
            "dob": dob,
            "patient_hash": ph,
            "total_score": total,
            "responses": st.session_state["responses"],
        }
        try:
            append_to_sheet(record)
            st.session_state["saved"] = True
            st.success(f"ì €ì¥ ì™„ë£Œ! (patient_hash: {ph})")
        except Exception as e:
            st.error("ì €ì¥ ì‹¤íŒ¨: Google Sheets ì„¤ì •/ê¶Œí•œ/Secretsë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.")
            st.exception(e)

    st.divider()
    st.subheader("í˜„ì¬ ê²°ê³¼ CSV ë‹¤ìš´ë¡œë“œ(ë¡œì»¬)")
    export_row = {
        "created_at": datetime.now().isoformat(timespec="seconds"),
        "name": name,
        "dob": dob,
        "patient_hash": ph,
        "total_score": total,
        **st.session_state["responses"],
    }
    export_df = pd.DataFrame([export_row])
    st.download_button(
        "â¬‡ï¸ í˜„ì¬ ê²°ê³¼ CSV ë‹¤ìš´ë¡œë“œ",
        data=export_df.to_csv(index=False, encoding="utf-8-sig"),
        file_name=f"mg_adl_{ph}_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv",
        mime="text/csv",
    )
